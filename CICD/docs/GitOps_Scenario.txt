# ğŸ› ï¸ On-Premise GitOps (Helm + DR) í†µí•© êµ¬ì¶• ê°€ì´ë“œ

## 1. ì•„í‚¤í…ì²˜ ë° íë¦„ (Workflow)
ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤(App)ì™€ ë°°í¬ ì„¤ì •(Helm) ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” í‘œì¤€ GitOps ë°©ì‹ì…ë‹ˆë‹¤.

1. Dev: ê°œë°œìê°€ App Repoì— ì½”ë“œ Push
2. CI (Jenkins): ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ -> Harbor Push (ìë™ ë°±ì—…)
3. CD Trigger (Jenkins): Jenkinsê°€ Helm Repoì˜ values.yaml ì´ë¯¸ì§€ íƒœê·¸ ìˆ˜ì • í›„ Commit/Push
4. CD (ArgoCD): Helm Repo ë³€ê²½ ê°ì§€ -> K8sì— Helm Chart ê¸°ë°˜ ë°°í¬/ì—…ë°ì´íŠ¸

---

## 2. Gitea ë¦¬í¬ì§€í† ë¦¬ êµ¬ì„± (ì‚¬ì „ ì¤€ë¹„)
ë‘ ê°œì˜ ì €ì¥ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤. (ì†ŒìŠ¤ì™€ ì„¤ì •ì˜ ë¶„ë¦¬)

1. Application Repo: ì‹¤ì œ ê°œë°œ ì†ŒìŠ¤ ì½”ë“œ (index.html, main.go ë“±)
2. Helm Chart Repo: K8s ë°°í¬ë¥¼ ìœ„í•œ Helm ì°¨íŠ¸ íŒŒì¼ë“¤
    * êµ¬ì¡° ì˜ˆì‹œ:
        my-helm-chart/
        â”œâ”€â”€ Chart.yaml
        â”œâ”€â”€ templates/
        â”‚   â”œâ”€â”€ deployment.yaml
        â”‚   â””â”€â”€ service.yaml
        â””â”€â”€ values.yaml  <-- Jenkinsê°€ ì´ íŒŒì¼ì˜ 'tag' ë¶€ë¶„ì„ ìˆ˜ì •í•¨

---

## 3. Harbor ìë™ ë°±ì—… ì„¤ì • (DR)
VM ì‚­ì œ/ì¥ì•  ì‹œ ì´ë¯¸ì§€ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ Docker Hubë¡œ ìë™ ë³µì œí•©ë‹ˆë‹¤.

1. Harbor > Registries > New Endpoint > Docker Hub ê³„ì • ë“±ë¡ (docker-hub-public).
2. Harbor > Replications > New Rule ìƒì„±.
    * Source Resource: my-project/**
    * Destination: docker-hub-public
    * Trigger Mode: Event Based (í•„ìˆ˜ ì²´í¬)

---

## 4. Jenkins Pipeline Script (Jenkinsfile)
Jenkinsê°€ "ì•± ë¹Œë“œ" í›„ "Helm ì°¨íŠ¸ ì—…ë°ì´íŠ¸"ê¹Œì§€ ìˆ˜í–‰í•˜ë„ë¡ êµ¬ì„±í•©ë‹ˆë‹¤.

pipeline {
    agent any
    
    environment {
        // [1. í™˜ê²½ ì„¤ì •] ë³¸ì¸ í™˜ê²½ì— ë§ê²Œ IP ë° ê²½ë¡œ ìˆ˜ì •
        HARBOR_URL      = '10.2.2.xxx:80'
        IMAGE_NAME      = 'my-project/web-app'
        
        // [2. Git ì €ì¥ì†Œ ì£¼ì†Œ êµ¬ë¶„]
        GIT_APP_URL     = 'http://10.2.2.xxx/dev/my-app-source.git'   // ì†ŒìŠ¤ ì½”ë“œ
        GIT_HELM_URL    = 'http://10.2.2.xxx/ops/my-helm-chart.git'   // Helm ì°¨íŠ¸
        
        // [3. ìê²© ì¦ëª… ID (Jenkinsì— ë“±ë¡ëœ ID)]
        GIT_CRED_ID     = 'gitea-auth'
        HARBOR_CRED_ID  = 'harbor-auth'
    }
    
    stages {
        // 1ë‹¨ê³„: ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        stage('1. Checkout App Source') {
            steps {
                git branch: 'main', credentialsId: "${GIT_CRED_ID}", url: "${GIT_APP_URL}"
            }
        }
        
        // 2ë‹¨ê³„: ì´ë¯¸ì§€ ë¹Œë“œ ë° Harbor ì—…ë¡œë“œ (-> Docker Hub ìë™ ë°±ì—…ë¨)
        stage('2. Build & Push Image') {
            steps {
                script {
                    def imageTag = "v1.0.${BUILD_NUMBER}"
                    
                    withCredentials([usernamePassword(credentialsId: "${HARBOR_CRED_ID}", usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        // ì´ë¯¸ì§€ ë¹Œë“œ
                        sh "docker build -t ${HARBOR_URL}/${IMAGE_NAME}:${imageTag} ."
                        // ë¡œê·¸ì¸ ë° í‘¸ì‹œ
                        sh "docker login ${HARBOR_URL} -u $USER -p $PASS"
                        sh "docker push ${HARBOR_URL}/${IMAGE_NAME}:${imageTag}"
                        // ë””ìŠ¤í¬ ì •ë¦¬
                        sh "docker rmi ${HARBOR_URL}/${IMAGE_NAME}:${imageTag}"
                    }
                }
            }
        }
        
        // 3ë‹¨ê³„: Helm ì°¨íŠ¸ ë²„ì „ ì—…ë°ì´íŠ¸ (GitOps í•µì‹¬)
        stage('3. Update Helm Chart') {
            steps {
                script {
                    def imageTag = "v1.0.${BUILD_NUMBER}"
                    
                    // Helm ì°¨íŠ¸ ì €ì¥ì†Œë§Œ ë³„ë„ í´ë”ì— ì²´í¬ì•„ì›ƒ
                    dir('helm-repo') {
                        git branch: 'main', credentialsId: "${GIT_CRED_ID}", url: "${GIT_HELM_URL}"
                        
                        // values.yaml íŒŒì¼ ë‚´ì˜ tag ê°’ì„ sedë¡œ ì¹˜í™˜
                        // (ì „ì œ: values.yaml ì•ˆì— tag: "..." í˜¹ì€ imageTag: "..." ê°€ ì¡´ì¬í•´ì•¼ í•¨)
                        sh "sed -i 's/tag: .*/tag: \"${imageTag}\"/g' values.yaml"
                        
                        // ë³€ê²½ëœ Helm ì°¨íŠ¸ë¥¼ Giteaì— Push
                        withCredentials([usernamePassword(credentialsId: "${GIT_CRED_ID}", usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                            sh "git config user.email 'jenkins@bot.local'"
                            sh "git config user.name 'Jenkins CI'"
                            sh "git add values.yaml"
                            sh "git commit -m 'Release: Update image tag to ${imageTag}'"
                            // ì¸ì¦ ì •ë³´ í¬í•¨í•˜ì—¬ Push
                            sh "git push http://${GIT_USER}:${GIT_PASS}@${GIT_HELM_URL.replace('http://', '')} HEAD:main"
                        }
                    }
                }
            }
        }
    }
}

---

## 5. ArgoCD ì„¤ì • (Application ìƒì„±)
ArgoCDëŠ” Helm ì°¨íŠ¸ ì €ì¥ì†Œë¥¼ ë°”ë¼ë³´ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

* Application Name: my-web-service
* Source:
    * Repository URL: GIT_HELM_URL (ìœ„ Jenkinsfileì˜ ì£¼ì†Œ)
    * Path: . (Chart.yamlì´ ìˆëŠ” ê²½ë¡œ)
    * Target Revision: HEAD
* Destination:
    * Cluster URL: https://kubernetes.default.svc
    * Namespace: dev (ë°°í¬í•  ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
* Sync Policy:
    * [x] Automatic (ìë™ ë°°í¬ í™œì„±í™”)
    * [x] Prune Resources (ì°¨íŠ¸ì—ì„œ ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì‹œ K8sì—ì„œë„ ì‚­ì œ)
    * [x] Self Heal (K8s ìƒíƒœê°€ ë³€ê²½ë˜ë©´ ìë™ ë³µêµ¬)

---

## 6. ë™ì‘ í™•ì¸ (Scenario)
1. Dev: index.html ìˆ˜ì • í›„ App Repoì— Push.
2. Jenkins:
    * ìƒˆ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ì—¬ Harborì— Push (íƒœê·¸: v1.0.25).
    * (HarborëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ Docker Hubë¡œ v1.0.25 ë°±ì—… ìˆ˜í–‰).
    * Helm Repoì˜ values.yamlì„ ì—´ì–´ íƒœê·¸ë¥¼ v1.0.25ë¡œ ìˆ˜ì • í›„ Commit.
3. ArgoCD:
    * Helm Repoê°€ ë³€ê²½ëœ ê²ƒì„ ê°ì§€.
    * "ì•„, ì´ë¯¸ì§€ê°€ v1.0.25ë¡œ ë°”ë€Œì—ˆêµ¬ë‚˜" ì¸ì‹.
    * K8s íŒŒë“œë¥¼ ë¡¤ë§ ì—…ë°ì´íŠ¸ ìˆ˜í–‰.