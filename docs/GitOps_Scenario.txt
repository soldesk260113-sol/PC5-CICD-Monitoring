# ğŸ› ï¸ On-Premise GitOps (Helm + DR) í†µí•© êµ¬ì¶• ê°€ì´ë“œ

## 1. ì•„í‚¤í…ì²˜ ë° íë¦„ (Workflow)
ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤(App)ì™€ ë°°í¬ ì„¤ì •(Helm) ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” í‘œì¤€ GitOps ë°©ì‹ì…ë‹ˆë‹¤.

1. Dev: ê°œë°œìê°€ App Repo(`myapp-source.git`)ì— ì½”ë“œ Push
2. CI (Jenkins): ë„ì»¤ ì´ë¯¸ì§€(`my-web`) ë¹Œë“œ -> Harbor Push (ìë™ ë°±ì—…)
3. CD Trigger (Jenkins): Jenkinsê°€ Helm Repo(`myapp-helm.git`)ì˜ `values.yaml` ì´ë¯¸ì§€ íƒœê·¸ ìˆ˜ì • í›„ Commit/Push
4. CD (ArgoCD): Helm Repo ë³€ê²½ ê°ì§€ -> K8sì— Helm Chart ê¸°ë°˜ ë°°í¬/ì—…ë°ì´íŠ¸

---

## 2. Gitea ë¦¬í¬ì§€í† ë¦¬ êµ¬ì„±
ë‘ ê°œì˜ ì €ì¥ì†Œë¡œ ë¶„ë¦¬í•˜ì—¬ ìš´ì˜í•©ë‹ˆë‹¤.

1. **Application Repo** (`admin/myapp-source.git`):
   - ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤ ì½”ë“œ
   - `src/`, `Dockerfile`, `package.json`
   - `Jenkinsfile`: CI/CD íŒŒì´í”„ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬

2. **Helm Chart Repo** (`admin/myapp-helm.git`):
   - K8s ë°°í¬ë¥¼ ìœ„í•œ Helm ì°¨íŠ¸ ëª¨ìŒ (ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ êµ¬ì¡°)
   - `my-web/`, `map-api/`, `energy-api/`, `kma-api/` ê° í´ë”ë³„ë¡œ ì°¨íŠ¸ ì¡´ì¬
   - JenkinsëŠ” ì´ ì¤‘ `my-web/helm/values.yaml`ì˜ íƒœê·¸ ì •ë³´ë¥¼ ìˆ˜ì •í•¨

---

## 3. Jenkins Pipeline Script (ì£¼ìš” ë¡œì§)
JenkinsëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ í›„, Helm ì°¨íŠ¸ì˜ ë²„ì „ì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ë°°í¬ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.

```groovy
pipeline {
    agent any
    
    environment {
        HARBOR_HOST = '10.2.2.40:5000'
        IMAGE_NAME = 'my-web'
        GITEA_HOST = '10.2.2.40:3001'
    }
    
    stages {
        // [Build & Push]
        stage('Build & Push Image') {
            steps {
                // Docker Build -> Tagging -> Push to Harbor
                sh "docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} ."
                sh "docker push ${HARBOR_HOST}/library/${IMAGE_NAME}:${BUILD_NUMBER}"
            }
        }
        
        // [GitOps Update]
        stage('Update Helm Chart') {
            steps {
                // Helm Repo Clone -> values.yaml ìˆ˜ì • -> Git Push
                sh """
                    git clone http://.../admin/myapp-helm.git .
                    sed -i "s/tag: .*/tag: \\"${BUILD_NUMBER}\\"/" my-web/helm/values.yaml
                    git commit -m "Bump my-web image tag to ${BUILD_NUMBER}"
                    git push origin main
                """
            }
        }
    }
}
```

---

## 4. ArgoCD ì„¤ì • (Multi-App Management)

ê°œë³„ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í•˜ë‚˜ì”© ì›¹ UIì—ì„œ ë“±ë¡í•˜ëŠ” ê²ƒì€ ë¹„íš¨ìœ¨ì ì…ë‹ˆë‹¤.
ë”°ë¼ì„œ **Declarative(ì„ ì–¸ì )** ë°©ì‹ìœ¼ë¡œ, ì—¬ëŸ¬ ì•±ì˜ ì„¤ì •ì„ ë‹´ì€ YAML íŒŒì¼(`argocd_apps.yaml`)ì„ í†µí•´ í•œ ë²ˆì— ê´€ë¦¬í•©ë‹ˆë‹¤.

### 4.1. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ êµ¬ì¡° (`argocd_apps.yaml`)
ì´ íŒŒì¼ì—ëŠ” 4ê°œì˜ `Application` ë¦¬ì†ŒìŠ¤ê°€ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì˜ˆì‹œ(my-web)ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-web           # ArgoCDì—ì„œ ë³´ì—¬ì§ˆ ì•± ì´ë¦„
  namespace: argocd      # ArgoCDê°€ ì„¤ì¹˜ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤
spec:
  project: default
  source:
    repoURL: http://10.2.2.40:3001/admin/myapp-helm.git  # Helm ì°¨íŠ¸ ì €ì¥ì†Œ
    targetRevision: HEAD                                 # ì¶”ì í•  ë¸Œëœì¹˜ (HEAD=main)
    path: my-web/helm                                    # ì €ì¥ì†Œ ë‚´ ì°¨íŠ¸ ê²½ë¡œ
  destination:
    server: https://kubernetes.default.svc               # ë°°í¬ë  í´ëŸ¬ìŠ¤í„°
    namespace: production                                # ë°°í¬ë  K8s ë„¤ì„ìŠ¤í˜ì´ìŠ¤
  syncPolicy:
    automated:
      prune: true        # Gitì—ì„œ íŒŒì¼ì´ ì‚­ì œë˜ë©´ K8s ë¦¬ì†ŒìŠ¤ë„ ì‚­ì œ
      selfHeal: true     # ìˆ˜ë™ ë³€ê²½ì´ ë°œìƒí•˜ë©´ ìë™ìœ¼ë¡œ Git ìƒíƒœë¡œ ë³µêµ¬
    syncOptions:
      - CreateNamespace=true # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
```

### 4.2. ê´€ë¦¬ ëŒ€ìƒ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤
ì´ íŒŒì¼ í•˜ë‚˜ë¡œ ë‹¤ìŒ 4ê°œì˜ ì„œë¹„ìŠ¤ê°€ ë™ì‹œì— ë°°í¬ ë° ê´€ë¦¬ë©ë‹ˆë‹¤:
1. **map-api**: ì§€ë„ ê´€ë ¨ API ì„œë¹„ìŠ¤
2. **energy-api**: ì—ë„ˆì§€ ë°ì´í„° ì²˜ë¦¬ ì„œë¹„ìŠ¤
3. **kma-api**: ê¸°ìƒì²­ ë°ì´í„° ì—°ë™ ì„œë¹„ìŠ¤
4. **my-web**: ì‚¬ìš©ì ì›¹ ì¸í„°í˜ì´ìŠ¤ (Ingress í¬í•¨)

### 4.3. ì ìš© ë° ê´€ë¦¬ ëª…ë ¹ì–´
**ì•± ë“±ë¡/ì—…ë°ì´íŠ¸**:
```bash
kubectl apply -f /root/Antigravity/Ansible/argocd_apps.yaml
```

**ìƒíƒœ í™•ì¸**:
```bash
# ì•± ëª©ë¡ í™•ì¸
kubectl get application -n argocd

# ìƒì„¸ ìƒíƒœ í™•ì¸ (CLI)
argocd app get my-web
```

---

## 5. ë™ì‘ í™•ì¸ (Scenario) - **ê²€ì¦ ì™„ë£Œ**
1. **Dev (User)**: ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  Giteaì— Push í•©ë‹ˆë‹¤.
2. **Jenkins**:
    * `my-web:4` ì´ë¯¸ì§€ ë¹Œë“œ ë° Harbor ì—…ë¡œë“œ ì™„ë£Œ.
    * Helm ë¦¬í¬ì§€í† ë¦¬ì˜ `my-web/helm/values.yaml` íƒœê·¸ë¥¼ `4`ë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ.
3. **ArgoCD**:
    * ë³€ê²½ ì‚¬í•­ì„ ê°ì§€í•˜ì—¬ ìƒíƒœê°€ `OutOfSync` -> `Synced`ë¡œ ë³€ê²½ë¨.
    * Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ `my-web` íŒŒë“œê°€ `v4` ì´ë¯¸ì§€ë¡œ êµì²´ë¨.