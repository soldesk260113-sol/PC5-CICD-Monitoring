---
# ═══════════════════════════════════════════════════════════════════════════
# Playbook 01: Common Setup - 모든 서버 기초 환경 구축
# 설명: 모든 서버(17대)에 공통적으로 적용되는 패키지 설치, 시간 동기화, 호스트 파일 설정 등을 수행합니다.
# ═══════════════════════════════════════════════════════════════════════════
- name: 공통 설정 (Hosts 파일, 방화벽, 패키지)
  hosts: All_Nodes
  become: yes
  tasks:
    - name: Hosts 파일 설정 (DNS 등록)
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item].ansible_host }} {{ item }}"
        state: present
      loop: "{{ groups['All_Nodes'] }}"
      tags: hosts_file

    - name: Firewalld 서비스 활성화 및 시작
      service:
        name: firewalld
        state: started
        enabled: yes
      ignore_errors: yes

    - name: 호스트네임 Prefix 결정 (Tier 감지)
      set_fact:
        tier_prefix: >-
          {%- if inventory_hostname in ['SECURE', 'WAF', 'DNS'] -%}PC1
          {%- elif 'ControlPlane' in inventory_hostname -%}PC2
          {%- elif inventory_hostname in ['K8S-WorkerNode1', 'K8S-WorkerNode2', 'K8S-WorkerNode3'] -%}PC3
          {%- elif 'DB' in inventory_hostname or 'Storage' in inventory_hostname -%}PC4
          {%- elif inventory_hostname in ['CI-OPS', 'Monitoring'] -%}PC5
          {%- elif inventory_hostname in ['K8S-WorkerNode4', 'K8S-WorkerNode5', 'K8S-WorkerNode6'] -%}PC6
          {%- else -%}PCX{%- endif -%}

    - name: "호스트네임 설정 (ex: PC1-SECURE)"
      hostname:
        name: "{{ tier_prefix }}-{{ inventory_hostname }}"

    - name: Bash 프롬프트 색상 설정 (Tier별 자동 지정)
      blockinfile:
        path: /root/.bashrc
        marker: "# {mark} ANSIBLE MANAGED PROMPT COLOR"
        content: |
          # Tier-based Prompt Color
          # PC1(Red), PC2(Green), PC3(Yellow), PC4(Blue), PC5(Purple), PC6(Cyan)
          case "$(hostname)" in
            PC1*) COLOR="91" ;; # Red
            PC2*) COLOR="92" ;; # Green
            PC3*) COLOR="93" ;; # Yellow
            PC4*) COLOR="94" ;; # Blue
            PC5*) COLOR="95" ;; # Purple
            PC6*) COLOR="96" ;; # Cyan
            *)    COLOR="0"  ;; # Default
          esac
          
          export PS1="\[\e[${COLOR};1m\][\u@\h\[\e[33;1m\] \w]\$ \[\e[m\]"
          alias c='clear'
          alias rm='rm -i'
          alias cp='cp -i'
          alias mv='mv -i'

    - name: 배포 - pingtest.sh (연결 테스트 스크립트)
      copy:
        src: "{{ playbook_dir }}/../Script/pingtest.sh"
        dest: /usr/local/bin/pingtest.sh
        mode: '0755'

# ═══════════════════════════════════════════════════════════════════════════
# [추가 설정] GUI 및 데스크탑 환경 조성 (Chrome, VSCode, Shortcuts)
# 대상: 모든 서버 (All_Nodes)
# ═══════════════════════════════════════════════════════════════════════════
- name: GUI & Desktop Environment Setup (All Nodes)
  hosts: All_Nodes
  become: yes
  tasks:
    # 2.1 Google Chrome 설치 (RPM 직접 다운로드 방식)
    - name: Chrome 설치 여부 확인
      command: which google-chrome-stable
      register: chrome_installed
      changed_when: false
      failed_when: false
      ignore_errors: yes

    - name: Google Chrome RPM 다운로드
      get_url:
        url: https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm
        dest: /tmp/google-chrome-stable.rpm
        mode: '0644'
      when: chrome_installed.rc != 0
      ignore_errors: yes

    - name: Chrome RPM 설치
      dnf:
        name: /tmp/google-chrome-stable.rpm
        state: present
        disable_gpg_check: yes
      when: chrome_installed.rc != 0
      ignore_errors: yes

    - name: Chrome RPM 파일 삭제
      file:
        path: /tmp/google-chrome-stable.rpm
        state: absent
      when: chrome_installed.rc != 0
      ignore_errors: yes

    # 2.2 VS Code 설치
    - name: Microsoft GPG Key 가져오기
      rpm_key:
        state: present
        key: https://packages.microsoft.com/keys/microsoft.asc
      ignore_errors: yes

    - name: VS Code Repo 추가
      copy:
        dest: /etc/yum.repos.d/vscode.repo
        content: |
          [code]
          name=Visual Studio Code
          baseurl=https://packages.microsoft.com/yumrepos/vscode
          enabled=1
          gpgcheck=1
          gpgkey=https://packages.microsoft.com/keys/microsoft.asc

    - name: DNF 캐시 갱신 (VS Code Repo)
      command: dnf makecache --disablerepo=* --enablerepo=code
      changed_when: false
      ignore_errors: yes

    - name: VS Code 설치
      dnf:
        name: code
        state: present
      ignore_errors: yes

    # 2.3 GNOME 확장 및 GUI 툴
    - name: GNOME 확장 및 트윅 도구 설치
      dnf:
        name: 
          - gnome-extensions-app
          - gnome-tweaks
          - dconf-editor
          - gnome-shell-extension-desktop-icons
        state: present
      ignore_errors: yes

    # 2.4 바탕화면 바로가기 설정
    - name: 바탕화면 디렉토리 경로 감지 (언어별 대응)
      shell: "xdg-user-dir DESKTOP || echo $HOME/Desktop"
      register: desktop_dir
      changed_when: false
      ignore_errors: yes

    - name: 바탕화면 디렉토리 변수 설정
      set_fact:
        desktop_path: "{{ desktop_dir.stdout | default('/root/Desktop') }}"

    - name: 바탕화면 디렉토리 생성 (없을 경우)
      file:
        path: "{{ desktop_path }}"
        state: directory
        mode: '0755'

    - name: Antigravity 바로가기 아이콘 생성
      copy:
        dest: "{{ desktop_path }}/Antigravity.desktop"
        content: |
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=Antigravity Project
          Comment=Open Antigravity Folder
          Exec=nautilus /root/Antigravity
          Icon=utilities-terminal
          Terminal=false
          StartupNotify=true
        mode: '0755'

    - name: Google Chrome 바로가기 아이콘 생성
      copy:
        dest: "{{ desktop_path }}/google-chrome.desktop"
        content: |
          [Desktop Entry]
          Version=1.0
          Name=Google Chrome
          GenericName=Web Browser
          Comment=Access the Internet
          Exec=/usr/bin/google-chrome-stable --no-sandbox %U
          StartupNotify=true
          Terminal=false
          Icon=google-chrome
          Type=Application
          Categories=Network;WebBrowser;
          MimeType=text/html;text/xml;application/xhtml_xml;image/webp;x-scheme-handler/http;x-scheme-handler/https;x-scheme-handler/ftp;
        mode: '0755'

    - name: VS Code 바로가기 아이콘 생성 (Root 권한 설정 포함)
      copy:
        dest: "{{ desktop_path }}/code.desktop"
        content: |
          [Desktop Entry]
          Name=Visual Studio Code
          Comment=Code Editing. Redefined.
          GenericName=Text Editor
          Exec=/usr/share/code/code --user-data-dir=/root/.vscode-root --no-sandbox --disable-gpu-sandbox %F
          Icon=vscode
          Type=Application
          StartupNotify=false
          StartupWMClass=Code
          Categories=TextEditor;Development;IDE;
          MimeType=application/x-code-workspace;
          Actions=new-empty-window;
          Keywords=vscode;

          [Desktop Action new-empty-window]
          Name=New Empty Window
          Name[ko]=새 빈 창
          Exec=/usr/share/code/code --user-data-dir=/root/.vscode-root --no-sandbox --disable-gpu-sandbox --new-window %F
          Icon=vscode
        mode: '0755'
