# ═══════════════════════════════════════════════════════════════════════════
# Playbook 07-App: Deploy ArgoCD Applications - 앱 배포 자동화 설정
# ═══════════════════════════════════════════════════════════════════════════
- name: Deploy ArgoCD Applications
  hosts: K8S_Primary_Master
  become: yes
  tasks:
    # App of Apps 패턴 적용:
    # - 모든 마이크로서비스(map-api, energy-api, kma-api, my-web)의 설정을 담은
    #   상위 메타 애플리케이션을 배포합니다.
    - name: Copy argocd_apps.yaml to Master Node
      copy:
        src: "{{ playbook_dir }}/../k8s_manifests/argocd/argocd_apps.yaml"
        dest: /root/argocd_apps.yaml

    - name: Apply ArgoCD Applications (동기화 시작)
      shell: kubectl apply -f /root/argocd_apps.yaml
      register: apply_result

    - name: Clean up temporary file (임시 파일 제거)
      file:
        path: /root/argocd_apps.yaml
        state: absent

    - name: Display Apply Result
      debug:
        msg: "{{ apply_result.stdout_lines }}"