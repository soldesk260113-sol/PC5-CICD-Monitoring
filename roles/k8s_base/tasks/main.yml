---
# ═══════════════════════════════════════════════════════════════════════════
# K8s Base Role - 마스터/워커 공통 설정
# ═══════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# 1. 시스템 사전 조건
# ─────────────────────────────────────────────────────────────────────────────
- name: 1-1. Swap 비활성화 (즉시)
  ansible.builtin.command: swapoff -a
  changed_when: false
- name: 1-2. Swap 영구 비활성화 (/etc/fstab)
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '.*swap.*'
    state: absent
- name: 1-3. 필수 커널 모듈 설정 파일 생성
  ansible.builtin.copy:
    content: |
      overlay
      br_netfilter
    dest: /etc/modules-load.d/k8s.conf
    mode: '0644'
- name: 1-4. 커널 모듈 로드
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: 1-5. K8s 네트워크 sysctl 설정
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/k8s.conf
    reload: yes
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { key: 'net.ipv4.ip_forward', value: '1' }

- name: 1-6. SELinux permissive 모드 설정
  ansible.posix.selinux:
    policy: targeted
    state: permissive
  ignore_errors: yes

- name: 1-7. 호스트 이름 설정 (Inventory 이름과 동기화)
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: 1-8. /etc/hosts 파일 구성
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[item].ansible_host }} {{ item }} {{ item | lower | replace('_', '-') }}"
    regexp: "^{{ hostvars[item].ansible_host }}"
    state: present
  loop: "{{ groups['K8S_Cluster'] }}"
  run_once: false

# ─────────────────────────────────────────────────────────────────────────────
# 2. Container Runtime (containerd)
# ─────────────────────────────────────────────────────────────────────────────

- name: 2-1. Docker 리포지토리 추가
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/centos/docker-ce.repo
    dest: /etc/yum.repos.d/docker-ce.repo

- name: 2-2. containerd.io 패키지 설치
  ansible.builtin.dnf:
    name: containerd.io
    state: present

- name: 2-3. containerd 설정 디렉토리 생성
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
    mode: '0755'

- name: 2-4. containerd 설정 파일 배포 (SystemdCgroup 활성화)
  ansible.builtin.template:
    src: config.toml.j2
    dest: /etc/containerd/config.toml
    mode: '0644'
  notify: Restart containerd

- name: 2-4-1. Harbor 레지스트리 설정 디렉토리 생성
  ansible.builtin.file:
    path: /etc/containerd/certs.d/10.2.2.40:5000
    state: directory
    mode: '0755'

- name: 2-4-2. Harbor 레지스트리 hosts.toml 생성
  ansible.builtin.copy:
    dest: /etc/containerd/certs.d/10.2.2.40:5000/hosts.toml
    content: |
      server = "http://10.2.2.40:5000"

      [host."http://10.2.2.40:5000"]
        capabilities = ["pull", "resolve", "push"]
        skip_verify = true
    mode: '0644'

- name: 2-5. containerd 서비스 활성화 및 시작
  ansible.builtin.service:
    name: containerd
    state: started
    enabled: yes

# ─────────────────────────────────────────────────────────────────────────────
# 3. Kubernetes 패키지 설치
# ─────────────────────────────────────────────────────────────────────────────

- name: 3-1. K8s 리포지토리 추가
  ansible.builtin.yum_repository:
    name: kubernetes
    description: Kubernetes Repository
    baseurl: https://pkgs.k8s.io/core:/stable:/v{{ k8s_version | default('1.29') }}/rpm/
    enabled: yes
    gpgcheck: yes
    gpgkey: https://pkgs.k8s.io/core:/stable:/v{{ k8s_version | default('1.29') }}/rpm/repodata/repomd.xml.key

- name: 3-2. K8s 패키지 설치
  ansible.builtin.dnf:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present
    disable_excludes: kubernetes

- name: 3-3. kubelet 서비스 활성화
  ansible.builtin.service:
    name: kubelet
    enabled: yes

# ─────────────────────────────────────────────────────────────────────────────
# 4. 방화벽 설정
# ─────────────────────────────────────────────────────────────────────────────

# ─────────────────────────────────────────────────────────────────────────────
# 4. 방화벽 설정
# ─────────────────────────────────────────────────────────────────────────────
- name: 4-0. Firewalld 설치 및 시작
  ansible.builtin.dnf:
    name: firewalld
    state: present

- name: 4-0-1. Firewalld 서비스 활성화 및 시작
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: yes

- name: 4-1. K8s 필수 포트 방화벽 허용
  ansible.posix.firewalld:
    port: "{{ item }}/tcp"
    permanent: yes
    immediate: yes
    state: enabled
  loop:
    - 6443   # API Server
    - 10250  # Kubelet API
    - 10251  # kube-scheduler
    - 10252  # kube-controller-manager
  ignore_errors: yes