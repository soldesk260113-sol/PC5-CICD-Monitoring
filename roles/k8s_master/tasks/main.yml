---
# ═══════════════════════════════════════════════════════════════════════════
# K8s Master Role - 마스터 노드 전용 설정
# ═══════════════════════════════════════════════════════════════════════════
# ─────────────────────────────────────────────────────────────────────────────
# 1. 클러스터 초기화 상태 확인
# ─────────────────────────────────────────────────────────────────────────────
- name: 1-1. 클러스터 초기화 여부 확인
  ansible.builtin.stat:
    path: /etc/kubernetes/admin.conf
  register: k8s_admin_conf

- name: 1-2. 이미 초기화된 경우 알림
  ansible.builtin.debug:
    msg: "✅ 클러스터가 이미 초기화되어 있습니다. kubeadm init 단계를 건너뜁니다."
  when: k8s_admin_conf.stat.exists

- name: 1-3. Etcd 포트(2379-2380) 방화벽 허용 (HA 구성 필수)
  ansible.posix.firewalld:
    port: "{{ item }}/tcp"
    permanent: yes
    immediate: yes
    state: enabled
  loop:
    - 2379
    - 2380
  ignore_errors: yes
- name: 2-1. 쿠버네티스 클러스터 초기화 (kubeadm init)
  ansible.builtin.shell: |
    # --upload-certs: 인증서를 k8s secret에 업로드하여 다른 마스터가 가져갈 수 있게 함
    kubeadm init --control-plane-endpoint "10.2.2.100:6444" --pod-network-cidr={{ pod_network_cidr | default('10.244.0.0/16') }} --upload-certs
  register: kube_init
  when: 
    - k8s_role_mode == 'init'
    - not k8s_admin_conf.stat.exists

- name: 2-2. 초기화 결과 출력
  ansible.builtin.debug:
    msg: "{{ kube_init.stdout_lines | default(['신규 초기화 없음']) }}"
  when: 
    - k8s_role_mode == 'init'
    - kube_init.changed | default(false)

# ─────────────────────────────────────────────────────────────────────────────
# 2-A. Secondary Master 조인 준비 (Join Mode)
# ─────────────────────────────────────────────────────────────────────────────
- name: 2-A-1. Primary Master에서 조인 명령어 및 인증서 키 가져오기
  delegate_to: "{{ groups['K8S_Primary_Master'][0] }}"
  block:
    - name: 새 인증서 키 생성
      command: kubeadm init phase upload-certs --upload-certs
      register: cert_key_output
      
    - name: 조인 토큰 생성
      command: kubeadm token create --print-join-command
      register: join_cmd_output
  run_once: yes
  when: 
    - k8s_role_mode == 'join_master'
    - not k8s_admin_conf.stat.exists

- name: 2-A-2. Secondary Master 클러스터 조인 (Control Plane)
  ansible.builtin.command: "{{ join_cmd_output.stdout | default('kubeadm join mock') }} --control-plane --certificate-key {{ (cert_key_output.stdout_lines | default(['mock_key']))[-1] }}"
  when: 
    - k8s_role_mode == 'join_master'
    - not k8s_admin_conf.stat.exists
    - not ansible_check_mode

# ─────────────────────────────────────────────────────────────────────────────
# 3. kubeconfig 설정 (Common)
# ─────────────────────────────────────────────────────────────────────────────
- name: 3-1. 관리자 설정 디렉토리 생성
  ansible.builtin.file:
    path: /root/.kube
    state: directory
    mode: '0755'

- name: 3-2. kubeconfig 파일 복사
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    remote_src: yes
    mode: '0600'
  ignore_errors: yes

# ─────────────────────────────────────────────────────────────────────────────
# 4. CNI 네트워크 플러그인 설치 (Primary Only)
# ─────────────────────────────────────────────────────────────────────────────
- name: 4-1. Flannel CNI 설치 여부 확인
  ansible.builtin.shell: kubectl get pods -n kube-flannel --no-headers 2>/dev/null | grep -c flannel || echo "0"
  register: flannel_check
  changed_when: false
  when: k8s_role_mode == 'init'

- name: 4-2. Flannel CNI 설치
  ansible.builtin.shell: kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
  when: 
    - k8s_role_mode == 'init'
    - flannel_check.stdout | int == 0

- name: 4-3. Flannel 이미 설치됨 알림
  ansible.builtin.debug:
    msg: "✅ Flannel CNI가 이미 설치되어 있습니다."
  when: 
    - k8s_role_mode == 'init'
    - flannel_check.stdout | int > 0

# ─────────────────────────────────────────────────────────────────────────────
# 5. 마스터 노드 스케줄링 설정 (Primary Only - 선택적)
# HA 환경에서는 마스터 노드에 워크로드를 배치하지 않는 것이 일반적이나, 필요시 활성화
# ─────────────────────────────────────────────────────────────────────────────

# ─────────────────────────────────────────────────────────────────────────────
# 6. 클러스터 상태 확인 (Primary Only)
# ─────────────────────────────────────────────────────────────────────────────
- name: 6-1. 클러스터 노드 목록 출력
  ansible.builtin.shell: kubectl get nodes -o wide
  register: nodes_list
  changed_when: false
  when: k8s_role_mode == 'init'

- name: 6-2. 현재 노드 상태
  ansible.builtin.debug:
    msg: "{{ nodes_list.stdout_lines }}"
  when: 
    - k8s_role_mode == 'init'
    - nodes_list.stdout_lines is defined